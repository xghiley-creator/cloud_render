name: render

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: "Unique job id"
        required: true
      mp3_url:
        description: "Public MP3 URL"
        required: true
      bg_image_url:
        description: "Background image URL"
        required: true
      srt_text:
        description: "Full SRT text"
        required: true

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Configure credentials (R2)
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=us-east-1" >> $GITHUB_ENV

      - name: Install tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl

      - name: Download inputs
        run: |
          set -e
          curl -fL "${{ inputs.mp3_url }}" -o vo.mp3
          curl -fL "${{ inputs.bg_image_url }}" -o bg.png
          printf "%s" "${{ inputs.srt_text }}" > subs.srt
          ls -lh vo.mp3 bg.png subs.srt

      - name: Render MP4 (1280x720) + burned subtitles
        run: |
          set -e
          ffmpeg -y \
            -loop 1 -i bg.png \
            -i vo.mp3 \
            -vf "scale=1280:720:force_original_aspect_ratio=cover,crop=1280:720,subtitles=subs.srt:force_style='FontName=DejaVu Sans,FontSize=42,Outline=4,Shadow=1,MarginV=50'" \
            -c:v libx264 -tune stillimage -pix_fmt yuv420p \
            -c:a aac -b:a 192k \
            -shortest out.mp4
          ls -lh out.mp4

      - name: Upload MP4 to R2
        run: |
          set -e
          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 cp \
            out.mp4 "s3://${{ secrets.R2_BUCKET }}/outputs/${{ inputs.job_id }}/final.mp4" \
            --content-type "video/mp4"

      - name: Generate signed URL (30 min)
        id: sign
        run: |
          set -e
          URL=$(aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 presign \
            "s3://${{ secrets.R2_BUCKET }}/outputs/${{ inputs.job_id }}/final.mp4" \
            --expires-in 1800)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "$URL" > signed_url.txt

      - name: Upload signed URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed_url
          path: signed_url.txt
          retention-days: 1
