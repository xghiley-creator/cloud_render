name: r2_test

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: "Unique job id"
        required: true
      mp3_url:
        description: "Public MP3 URL"
        required: true


jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Show AWS CLI version (preinstalled)
        run: |
          set -e
          aws --version

      - name: Verify required secrets exist
        run: |
          set -e
          test -n "${{ secrets.R2_ENDPOINT }}" || (echo "Missing secret: R2_ENDPOINT" && exit 1)
          test -n "${{ secrets.R2_BUCKET }}" || (echo "Missing secret: R2_BUCKET" && exit 1)
          test -n "${{ secrets.R2_ACCESS_KEY_ID }}" || (echo "Missing secret: R2_ACCESS_KEY_ID" && exit 1)
          test -n "${{ secrets.R2_SECRET_ACCESS_KEY }}" || (echo "Missing secret: R2_SECRET_ACCESS_KEY" && exit 1)

      - name: Configure env (R2)
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=us-east-1" >> $GITHUB_ENV

      - name: Download MP3 from URL
        run: |
          set -e
          curl -L "${{ inputs.mp3_url }}" -o vo.mp3
          ls -lh vo.mp3

      - name: Upload MP3 to R2 (inputs/)
        run: |
          set -e
          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 cp \
            vo.mp3 "s3://${{ secrets.R2_BUCKET }}/inputs/${{ inputs.job_id }}/vo.mp3" \
            --content-type "audio/mpeg"

      - name: List bucket (proves creds + endpoint)
        run: |
          set -e
          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 ls "s3://${{ secrets.R2_BUCKET }}/"

      - name: Upload MP4 to R2 (outputs/)
        run: |
          set -e
          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 cp \
            out.mp4 "s3://${{ secrets.R2_BUCKET }}/outputs/${{ inputs.job_id }}/final.mp4" \
            --content-type "video/mp4"

      - name: Generate signed download URL (30 min)
        id: sign
        run: |
          set -e
          URL=$(aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 presign \
            "s3://${{ secrets.R2_BUCKET }}/outputs/${{ inputs.job_id }}/final.mp4" \
            --expires-in 1800)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "SIGNED_URL=$URL" >> $GITHUB_ENV

      - name: Save URL to artifact
        run: |
          echo "${SIGNED_URL}" > signed_url.txt

      - name: Upload artifact (signed_url.txt)
        uses: actions/upload-artifact@v4
        with:
          name: signed_url
          path: signed_url.txt
          retention-days: 1

      - name: Upload + download a tiny test file
        run: |
          set -e
          echo "hello from github actions" > test.txt

          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 cp \
            test.txt "s3://${{ secrets.R2_BUCKET }}/test/r2_test.txt" \
            --content-type "text/plain"

          aws --endpoint-url "${{ secrets.R2_ENDPOINT }}" s3 cp \
            "s3://${{ secrets.R2_BUCKET }}/test/r2_test.txt" out.txt

          echo "Downloaded contents:"
          cat out.txt
